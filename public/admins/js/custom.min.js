$(function() {
    "use strict";
    $(function() {
        $(".preloader").fadeOut();
    }), jQuery(document).on("click", ".mega-dropdown", function(e) {
        e.stopPropagation();
    });
    var set = function() {
        (window.innerWidth > 0 ? window.innerWidth : this.screen.width) < 1170 ? ($("body").addClass("mini-sidebar"), 
            $(".navbar-brand span").hide(), $(".sidebartoggler i").addClass("ti-menu")) : ($("body").removeClass("mini-sidebar"), 
            $(".navbar-brand span").show());
            var height = (window.innerHeight > 0 ? window.innerHeight : this.screen.height) - 1;
            (height -= 0) < 1 && (height = 1), height > 0 && $(".page-wrapper").css("min-height", height + "px");
        };
        $(window).ready(set), $(window).on("resize", set), $(".sidebartoggler").on("click", function() {
            $("body").hasClass("mini-sidebar") ? ($("body").trigger("resize"), $("body").removeClass("mini-sidebar"), 
                $(".navbar-brand span").show()) : ($("body").trigger("resize"), $("body").addClass("mini-sidebar"), 
                $(".navbar-brand span").hide());
            }), $(".nav-toggler").click(function() {
                $("body").toggleClass("show-sidebar"), $(".nav-toggler i").toggleClass("ti-menu"), 
                $(".nav-toggler i").addClass("ti-close");
            }), $(".search-box a, .search-box .app-search .srh-btn").on("click", function() {
                $(".app-search").toggle(200);
            }), $(".right-side-toggle").click(function() {
                $(".right-sidebar").slideDown(50), $(".right-sidebar").toggleClass("shw-rside");
            }), $(".floating-labels .form-control").on("focus blur", function(e) {
                $(this).parents(".form-group").toggleClass("focused", "focus" === e.type || this.value.length > 0);
            }).trigger("blur"), $(function() {
                for (var url = window.location, element = $("ul#sidebarnav a").filter(function() {
                    return this.href == url;
                }).addClass("active").parent().addClass("active"); ;) {
                    if (!element.is("li")) break;
                    element = element.parent().addClass("in").parent().addClass("active");
                }
            }), $(function() {
                $('[data-toggle="tooltip"]').tooltip();
            }), $(function() {
                $('[data-toggle="popover"]').popover();
            }), $(function() {
                $("#sidebarnav").AdminMenu();
            }), //$(".scroll-sidebar, .right-side-panel, .message-center, .right-sidebar").perfectScrollbar(),
            $(".scroll-sidebar").mCustomScrollbar({
                setHeight: 550,
                autoHideScrollbar: true,
                scrollbarPosition: "outside",
                theme:"dark-1" 
            }),
            $("body").trigger("resize"), $(".list-task li label").click(function() {
                $(this).toggleClass("task-done");
            }), $('a[data-action="collapse"]').on("click", function(e) {
                e.preventDefault(), $(this).closest(".card").find('[data-action="collapse"] i').toggleClass("ti-minus ti-plus"), 
                $(this).closest(".card").children(".card-body").collapse("toggle");
            }), $('a[data-action="expand"]').on("click", function(e) {
                e.preventDefault(), $(this).closest(".card").find('[data-action="expand"] i').toggleClass("mdi-arrow-expand mdi-arrow-compress"), 
                $(this).closest(".card").toggleClass("card-fullscreen");
            }), $('a[data-action="close"]').on("click", function() {
                $(this).closest(".card").removeClass().slideUp("fast");
            });
        });

$(document).ready(function() {
    //Validación para introducir solo números
    $('.number, #phone, #dni').keypress(function() {
        return event.charCode >= 48 && event.charCode <= 57;
    });
    //Validación para introducir solo letras y espacios
    $('#name, #lastname').keypress(function() {
        return event.charCode >= 65 && event.charCode <= 90 || event.charCode >= 97 && event.charCode <= 122 || event.charCode==32;
    });
    //Validación para solo presionar enter y borrar
    $('.date').keypress(function() {
        return event.charCode == 32 || event.charCode == 127;
    });

    //datatable español
    var español = {
        "sProcessing":     "Procesando...",
        "sLengthMenu":     "Mostrar _MENU_ registros",
        "sZeroRecords":    "No se encontraron resultados",
        "sEmptyTable":     "Ningún resultado disponible en esta tabla",
        "sInfo":           "Resultados del _START_ al _END_ de un total de _TOTAL_ registros",
        "sInfoEmpty":      "No hay resultados",
        "sInfoFiltered":   "(filtrado de un total de _MAX_ registros)",
        "sInfoPostFix":    "",
        "sSearch":         "Buscar :",
        "sUrl":            "",
        "sInfoThousands":  ",",
        "sLoadingRecords": "Cargando...",
        "oPaginate": {
            "sFirst":    "Primero",
            "sLast":     "Último",
            "sNext":     "Siguiente",
            "sPrevious": "Anterior"
        },
        "oAria": {
            "sSortAscending":  ": Activar para ordenar la columna de manera ascendente",
            "sSortDescending": ": Activar para ordenar la columna de manera descendente"
        }
    }

    //datatable export
    if ($('#tablaExport').length) {
        $('#tablaExport').DataTable({
            dom: 'Bfrtip',
            buttons: ['excel', 'pdf'],
            "language": español
        });
    }

    //datatable normal
    if ($('#tabla').length) {
        $('#tabla').DataTable({
            "language": español
        });
    }

    //datepicker material
    if ($('.date').length) {
        $('.date').bootstrapMaterialDatePicker({
            time: false,
            cancelText: 'Cancelar',
            clearText: 'Limpiar',
            format: 'D-M-YYYY',
            minDate : new Date()
        });
    }

    //multiselect
    if ($('.multiselect').length) {
        $('.multiselect').multiselect({
            buttonClass: 'form-control',
            buttonWidth: '100%',
            maxHeight: 200,
            includeSelectAllOption: false,
            selectAllText: 'Seleccionar Todas',
            enableFiltering: true,
            enableCaseInsensitiveFiltering: true,
            filterPlaceholder: 'Buscar',
            includeFilterClearBtn: true,
            nonSelectedText: 'Seleccione',
            nSelectedText: 'Selecionados',
            allSelectedText: 'Todos Selecionados',
            numberDisplayed: 2,
            disableIfEmpty: true,
            disabledText: 'Seleccione',
            templates: {
                button: '<button type="button" style="text-align: left;" class="multiselect dropdown-toggle" data-toggle="dropdown"><span class="multiselect-selected-text"></span> <b class="caret" style="text-align: right;"></b></button>',
                ul: '<ul class="multiselect-container dropdown-menu"></ul>',
                filter: '<li class="multiselect-item multiselect-filter"><div class="input-group"><span class="input-group-addon"><i class="fa fa-search"></i></span><input class="form-control multiselect-search" type="text" /></div></li>',
                filterClearBtn: '<span class="input-group-btn"><button class="btn btn-default multiselect-clear-filter" type="button"><i class="fa fa-close"></i></button></span>',
                li: '<li style="margin-left: -25px;"><a tabindex="0"><label style="color: #000; width: 100%;"></label></a></li>',
                divider: '<li class="multiselect-item divider"></li>',
                liGroup: '<li class="multiselect-item multiselect-group"><label></label></li>',
                resetButton: '<li class="multiselect-reset text-center"><div class="input-group"><a class="btn btn-default btn-block"></a></div></li>'
            }
        });
    }

    //touchspin para los campos numericos
    if ($('.number').length) {
        $(".number").TouchSpin({
            min: 1,
            max: 99999999999,
            buttondown_class: 'btn btn-primary',
            buttonup_class: 'btn btn-primary'
        });
    }

    if ($('.ofert').length) {
        $(".ofert").TouchSpin({
            min: 0,
            max: 100,
            postfix: '%',
            buttondown_class: 'btn btn-primary',
            buttonup_class: 'btn btn-primary'
        });
    }

    if ($('.price').length) {
        $(".price").TouchSpin({
            min: 0,
            max: 99999999999,
            decimals: 2,
            prefix: 'S/.',
            buttondown_class: 'btn btn-primary',
            buttonup_class: 'btn btn-primary'
        });
    }

    if ($('.quality').length) {
        $(".quality").TouchSpin({
            min: 1,
            max: 5,
            step: 0.5,
            decimals: 1,
            buttondown_class: 'btn btn-primary',
            buttonup_class: 'btn btn-primary'
        });
    }

    //dropify para input file más personalizado
    if ($('.dropify').length) {
        $('.dropify').dropify({
            messages: {
                default: 'Arrastre y suelte una imagen o da click para seleccionarla',
                replace: 'Arrastre y suelte una imagen o haga click para reemplazar',
                remove: 'Remover',
                error: 'Lo sentimos, el archivo es demasiado grande'
            },
            error: {
                'fileSize': 'El tamaño del archivo es demasiado grande ({{ value }} máximo).',
                'minWidth': 'El ancho de la imagen es demasiado pequeño ({{ value }}}px mínimo).',
                'maxWidth': 'El ancho de la imagen es demasiado grande ({{ value }}}px máximo).',
                'minHeight': 'La altura de la imagen es demasiado pequeña ({{ value }}}px mínimo).',
                'maxHeight': 'La altura de la imagen es demasiado grande ({{ value }}px máximo).',
                'imageFormat': 'El formato de imagen no está permitido (Debe ser {{ value }}).'
            }
        });
    }

    //Jquery uploader
    if ($('#drop-area').length) {
        $('#drop-area').dmUploader({
            url: '/misterfix/imagenes/productos',
            maxFileSize: 3000000,
            headers: {
                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
            },
            onDragEnter: function(){
                this.addClass('active');
            },
            onDragLeave: function(){
                this.removeClass('active');
            },
            onBeforeUpload: function(){
                $('button').attr('disabled', true);
                $("#response").text('Subiendo Archivo...');
            },
            onUploadSuccess: function(id, data){
                var obj=JSON.parse(data);
                var text=$("#files").text();
                var val=$("#nameFiles").val();
                if (text=="") {
                    $("#files").text(obj.name);
                    $("#nameFiles").val(obj.nameFile);
                } else {
                    $("#files").text(obj.name+', '+text);
                    $("#nameFiles").val(obj.nameFile+','+val);
                }
                $('button').attr('disabled', false);
                $("#response").text('Correcto');
            },
            onUploadError: function(id, xhr, status, message){  
                $('button').attr('disabled', false);
                $("#response").text('Error');
            },
            onFileSizeError: function(file){
                $('button').attr('disabled', false);
                $("#response").text('El archivo \'' + file.name + '\' excede el tamaño máximo permitido.');
            }
        });
    }

    if ($('#drop-area2').length) {
        var productoSlug=$('#slug').val();
        $('#drop-area2').dmUploader({
            url: '/misterfix/imagenes/productos/'+productoSlug,
            maxFileSize: 3000000,
            headers: {
                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
            },
            onDragEnter: function(){
                this.addClass('active');
            },
            onDragLeave: function(){
                this.removeClass('active');
            },
            onBeforeUpload: function(){
                $('button').attr('disabled', true);
                $("#response").text('Subiendo Archivo...');
            },
            onUploadSuccess: function(id, data){
                var obj=JSON.parse(data);
                if (obj.status=='ok') {
                    $("#images").append($('<div>', {
                        'class': 'form-group col-lg-3 col-md-3 col-sm-6 col-12',
                        'element': 'image'+id
                    }).append($('<img>', {
                        'src': '../../../admins/img/products/'+obj.nameFile,
                        'class': 'rounded img-fluid'                            
                    })).append($('<button>', {
                        'type': 'button',
                        'class': 'btn btn-danger btn-sm btn-circle btn-absolute-right',
                        'photo': 'image'+id,
                        'urlPhoto': '../../../admins/img/products/'+obj.nameFile,
                        'onclick': 'deleteImageProduct("image'+id+'", "'+obj.nameFile+'", "'+obj.slug+'");'
                    }).append('<i class="fa fa-trash">')));
                    $('button').attr('disabled', false);
                    $("#response").text('Correcto');
                } else {
                    $('button').attr('disabled', false);
                    $("#response").text('Error');
                }
            },
            onUploadError: function(id, xhr, status, message){  
                $('button').attr('disabled', false);
                $("#response").text('Error');
            },
            onFileSizeError: function(file){
                $('button').attr('disabled', false);
                $("#response").text('El archivo \'' + file.name + '\' excede el tamaño máximo permitido.');
            }
        });
    }

    //Mapa de leaflet
    if ($('#lat').length && $('#lng').length && $('#map').length) {
        if ($('#lat').val()=="" || $('#lng').val()=="") {
            var map = L.map('map', {
                center: [-12.05, -77.04],
                zoom: 12
            });

            marker = L.marker([-12.05, -77.04]).addTo(map);
        } else {
            var mapLat=$('#lat').val();
            var mapLng=$('#lng').val();
            var map = L.map('map', {
                center: [mapLat, mapLng],
                zoom: 12
            });

            marker = L.marker([mapLat, mapLng]).addTo(map);
        }

        var geocoder = L.Control.Geocoder.nominatim();

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        map.on('click', function(e) {
            if (marker) {
                map.removeLayer(marker);
            }

            geocoder.reverse(e.latlng, map.options.crs.scale(map.getZoom()), function(results) {
                var r = results[0];
                $('#addressDelivery').val(r.name);
            });
            
            marker=L.marker(e.latlng).addTo(map);
            $('#lat').val(e.latlng.lat);
            $('#lng').val(e.latlng.lng);
        });
    }

    if ($('#latStore').length && $('#lngStore').length && $('#map').length) {
        var latStore=$('#latStore').val();
        var lngStore=$('#lngStore').val();
        var latUser=$('#latUser').val();
        var lngUser=$('#lngUser').val();

        var map = L.map('map', {
            center: [latStore, lngStore],
            zoom: 13
        });

        if (latUser!="" && lngUser!="") {
            L.Routing.control({
                waypoints: [
                L.latLng(latStore, lngStore),
                L.latLng(latUser, lngUser)
                ]
            }).addTo(map);
        } else {
            marker = L.marker([latStore, lngStore]).addTo(map);
        }

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
    }


    //Mostrar u ocultar campo de tienda en registro y edición de usuarios
    if ($('#typeUser').length) {
        var typeUser=$('#typeUser').val();
        if (typeUser!=2) {
            $('#storeField').addClass('d-none');
        } else {
            $('#storeField').removeClass('d-none');
        }
    }

    $('#typeUser').change(function() {
        $('#storeField option[value=""]').attr('selected', true);;
        if ($(this).val()!=2) {
            $('#storeField').addClass('d-none');
        } else {
            $('#storeField').removeClass('d-none');
        }
    });
});

//funciones para mostrar modal de usuario
function showUser(slug) {
    $.ajax({
        url: '/sistema/usuarios/'+slug,
        dataType: 'html',
    })
    .done(function(resultado) {
        var obj=JSON.parse(resultado);
        $('#photoUser').attr('src', '/admins/img/users/'+obj.photo);
        $('#nameUser').text(obj.name);
        $('#emailUser').text(obj.email);
        $('#stateUser').html(obj.state);
        $("#showUser").modal();
    });
};

//funciones para desactivar y activar usuarios
function deactiveUser(slug) {
    $("#deactiveUser").modal();
    $('#formDeactiveUser').attr('action', '/maesma/usuarios/desactivar/' + slug);
}

function activeUser(slug) {
    $("#activeUser").modal();
    $('#formActiveUser').attr('action', '/usuarios/activar/' + slug);
}

//funciones para desactivar y activar tiendas
function desactivateStore(slug) {
    $("#desactivateStore").modal();
    $('#formDesactiveStore').attr('action', '/tiendas/desactivar/' + slug);
}

function activateStore(slug) {
    $("#activeStore").modal();
    $('#formActiveStore').attr('action', '/tiendas/activar/' + slug);
}

//funciones para preguntar al eliminar

function deleteCategory(slug) {
    $("#deleteCategory").modal();
    $('#formDeleteCategory').attr('action', '/categorias/eliminar/' + slug);
}

function deleteStore(slug) {
    $("#deleteStore").modal();
    $('#formDeleteStore').attr('action', '/tiendas/' + slug);
}

function deleteProduct(slug) {
    $("#deleteProduct").modal();
    $('#formDeleteProduct').attr('action', '/productos/eliminar/' + slug);
}


///////////////////////////////////////Ventas//////////////////////////////

function confirmUsers(slug) {
    $("#confirmUsers").modal();
    $('#formConfirmUsers').attr('action', '/maesma/ventas/cajero-repartidor/' + slug);
}

function confirmState(slug) {
    $("#confirmState").modal();
    $('#formConfirmState').attr('action', '/maesma/ventas/estado/' + slug);
}

function confirmTime(slug) {
    $("#confirmTime").modal();
    $('#formConfirmTime').attr('action', '/maesma/ventas/tiempo/' + slug);
}


